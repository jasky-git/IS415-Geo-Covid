---
title: "IS415-Geo-Covid"
author: "IS415 Group 6 by: Ivy, Shermin, Jasky"
date: "10/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
```

# Introduction

# Getting Started
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
packages = c('lubridate','readxl','sp','tidyverse', 'sf',  'rgdal','spatstat', 'spatstat', 'raster', 'maptools', 'rgeos','dplyr', 'tmap', 'ggplot2', 'spdep', 'tidygeocoder')

for(p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p, character.only = T)
}
```

# Import data
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
hk_district <- st_read(dsn = "data/geospatial", layer = "HKDistrict18")
hk_region <- read.csv("data/geospatial/Hong_Kong_18_Districts.csv")
hk_location <- st_read(dsn = "data/geospatial", layer = "hong_kong_location")
pop_district_2016 <- read_csv("data/aspatial/Population by District Council and Year.csv")
pop_sex <- read.csv("data/aspatial/population-by-sex.csv")
confines_qc <- read_csv("data/aspatial/no_of_confines_by_types_in_quarantine_centres_eng.csv")
occupancy_qc <- read_csv("data/aspatial/occupancy_of_quarantine_centres_eng.csv")
indv_caseinfo <- read_csv("data/aspatial/enhanced_sur_covid_19_eng.csv")
reported_cases_by_country <- read_csv("data/aspatial/countries_areas_have_reported_cases_eng.csv")
testing_done_mth <- read_csv("data/aspatial/statistics_on_covid_19_testing_cumulative.csv")
reported_cases <- read_csv("data/aspatial/latest_situation_of_reported_cases_covid_19_eng.csv")
```


# Data Cleaning


## HK District and Region
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
hk_map <- cbind(hk_district, hk_region$REGION) %>%
  rename('REGION' = 'hk_region.REGION')
```

## Population by Sex in 2020
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
pop_sex_2020 <- pop_sex %>%
  filter(year == 2020) %>%
  mutate('total' = `male` + `female`)
```

## No. of Confines by Types in Quarantine Centres

### Check for duplicates
```{r}
duplicated(confines_qc)
```

```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
confines_qc$`As of date` <- as.Date(confines_qc$`As of date`, "%d/%m/%y")
confines_qc$`As of month` <- format(confines_qc$`As of date`, "%m")


confines_qc_cumul_close <- confines_qc %>%
  dplyr::select("As of date", "Cumulative number of close contacts of confirmed cases")
  
confines_qc_cumul_nonclose <- confines_qc %>%
  dplyr::select("As of date", "Cumulative number of non-close contacts")

confines_qc_current_close <- confines_qc %>%
  dplyr::select("As of date", "Current number of close contacts of confirmed cases")

confines_qc_cuurent_nonclose <- confines_qc %>%
  dplyr::select("As of date", "Current number of non-close contacts")
```


### Line graph

#### Cumulative number of close contact

```{r}
confines_cumul_close_line <- 
  ggplot(confines_qc_cumul_close, aes(x = `As of date`, y = `Cumulative number of close contacts of confirmed cases`)) +
  geom_line()

confines_cumul_close_line
```

#### Cumulative number of non-close contact

```{r}
confines_cumul_nonclose_line <- 
  ggplot(confines_qc_cumul_nonclose, aes(x = `As of date`, y = `Cumulative number of non-close contacts`)) +
  geom_line()

confines_cumul_nonclose_line
```

#### Current number of close contact

```{r}
confines_current_close_line <- 
  ggplot(confines_qc_current_close, aes(x = `As of date`, y = `Current number of close contacts of confirmed cases`)) +
  geom_line()

confines_current_close_line
```

#### Current numebr of non-close contacts

```{r}
confines_current_nonclose_line <- 
  ggplot(confines_qc_cuurent_nonclose, aes(x = `As of date`, y = `Current number of non-close contacts`)) +
  geom_line()

confines_current_nonclose_line

```


#### Filter for Monthly Number of Confirm cases and Death cases
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
reported_cases_filtered = reported_cases %>% 
  group_by(strftime(`As of date`, "%d-%m")) %>%
  filter(`As of date` == max(`As of date`))
  #%>% .$`As of date`

reported_cases_filtered$`As of date` <- as.Date(reported_cases_filtered$`As of date`, "%d/%m/%y")
reported_cases_filtered$`As_of_month` <- format(reported_cases_filtered$`As of date`, "%m")

reported_cases_filtered <- reported_cases_filtered %>%
  mutate(Month = case_when(
    between(As_of_month, 01, 01) ~ "January",
    between(As_of_month, 02, 02) ~ "Feburary",
    between(As_of_month, 03, 03) ~ "March",
    between(As_of_month, 04, 04) ~ "April",
    between(As_of_month, 05, 05) ~ "May",
    between(As_of_month, 06, 06) ~ "June",
    between(As_of_month, 07, 07) ~ "July",
    between(As_of_month, 08, 08) ~ "August",
    between(As_of_month, 09, 09) ~ "September"
    ))

reported_cases_filtered_ <- reported_cases_filtered %>%
  dplyr::select("As of date", "Month", "Number of confirmed cases", "Number of death cases")
  #arrange(Month)
```

#### Bar plot the Monthly Number of Confirm cases
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
reported_cases_bar_c <- barplot(reported_cases_filtered_$`Number of confirmed cases`, ylim = c(0, 5500), main = "2020 Monthly Number of Confirm Cases ", ylab="Number of Confirm Cases")
axis(1, at=reported_cases_bar_c, labels=reported_cases_filtered_$Month, las=2, cex.lab=4)
```

#### Line plot the Monthly Number of Confirm cases
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
reported_cases_line_c <-
  ggplot(reported_cases_filtered_, aes(x = `As of date`, y = `Number of confirmed cases`)) +
  geom_point() +
  geom_line() +
  #facet_grid(facets = Month ~ .) +
  #scale_x_date(labels = function(x) format(x, "%b")) +
  theme_bw()

reported_cases_line_c
```

#### Bar plot the Monthly Number of Death cases
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
reported_cases_bar_c <- barplot(reported_cases_filtered_$`Number of death cases`, ylim = c(0, 120), main = "2020 Monthly Number of Death Cases ", ylab="Number of Death Cases")
axis(1, at=reported_cases_bar_c, labels=reported_cases_filtered_$Month, las=2, cex.lab=4)
```

#### Line plot the Monthly Number of Death cases
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
reported_cases_line_d <-
  #ggplot(reported_cases_filtered_, aes(x = Month, y = `Number of death cases`)) +
  ggplot(reported_cases_filtered_, aes(x = `As of date`, y = `Number of death cases`)) +
  geom_point() +
  geom_line() +
  #facet_grid(facets = Month ~ .) +
  #scale_x_date(labels = function(x) format(x, "%b")) +
  theme_bw()

reported_cases_line_d
```

## Total No. of Reported Cases Daily in HK
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
hk_reported_cases <- reported_cases_by_country %>%
  filter(`Countries/areas` == 'Hong Kong Special Administrative Region')
```

# EPSG:2326
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
hk_map_2326 <- st_set_crs(hk_map, 2326)
hk_location_2326 <- st_set_crs(hk_location, 2326)
```

## indv_caseinfo

###Frequency of Covid'19 Cases based on Gender
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
freq_genderM <- indv_caseinfo %>%
  filter(Gender == 'M') %>%
  count(Gender) %>%
  rename(count = n)

freq_genderF <- indv_caseinfo %>%
  filter(Gender == 'F') %>%
  count(Gender) %>%
  rename(count = n)

freq_gender <- rbind(freq_genderM, freq_genderF)

ggplot(freq_gender, aes(x=Gender, y=count, fill=Gender)) + geom_bar(stat='identity', width = 0.7) + theme_minimal() + geom_text(aes(label=count), vjust=1.6, color="white", size=3.5)

```


###Confirmed Cases by Date
```{r echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE}
indv_caseinfo$`Report date` <- as.Date(indv_caseinfo$`Report date`, "%d/%m/%Y")

cases_date <- indv_caseinfo %>%
  mutate(count = 1) %>%
  dplyr::select('Case no.', 'Report date', 'count') %>%
  group_by(`Report date` = floor_date(`Report date`, "month")) %>%
  summarise(count = sum(count)) 

ggplot(cases_date, aes(x=`Report date`, y=count)) + geom_line() + geom_point() + scale_x_date(date_labels = "%m") + geom_text(aes(label=count), vjust=-0.5)
```

# Occupancy_qc

## Get unique centres

```{r}
quarantine <- distinct(occupancy_qc, `Quarantine centres`)
address <- distinct(occupancy_qc,`Address`)
centre_address <- occupancy_qc %>%
  dplyr::select(`Quarantine centres`, `Address`) %>%
  dplyr::mutate("~name" = `Quarantine centres`, "~addr" = `Address`) %>%
  dplyr::select("~name", "~addr")

centre_address
```

## Only take the string before the ,

```{r}
centre_address <- distinct(centre_address)
centre_address$`~addr` <-  gsub("\\,.*","",centre_address$`~addr`)
```

## Correct spelling or data errors

```{r}
centre_address[2,2] <- "No. 123 Fan Kam Road"
centre_address[5,2] <- "Tui Min Hoi"
centre_address[7,2] <- "Lantau Island"
```

## Compute Longitude and Latitude with geocode()

```{r}
lat_long <- centre_address %>%
  geocode(street = `~addr`, country = "Hong Kong", method = 'osm', lat = latitude , long = longitude)
```

## Convert crs to 2326

```{r}
lat_long <- as.data.frame(lat_long)

lat_long <- st_as_sf(lat_long, coords = c("longitude", "latitude"), crs = 2326)
```

## Plot confine centre on map

```{r}
tm_shape(hk_map_2326) + 
  tm_fill() +
  tm_borders(alpha = 0.3) +
  tm_shape(lat_long) +
    tm_dots(size = 0.1)
```










